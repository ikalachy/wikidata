#!/usr/bin/env bash
set -eEuo pipefail

SERVICES="pageviews entities load"
PROJECT_ID=bigquery-public-data-staging
IMAGE=wikisync

echo "building docker image..."
gcloud builds submit \
  --project "${PROJECT_ID}" \
  --tag "gcr.io/$PROJECT_ID/$IMAGE" \
  .

echo "deploying cloud run services..."
for SERVICE in $SERVICES
do
  gcloud beta run deploy "$SERVICE" \
    --image "gcr.io/$PROJECT_ID/$IMAGE" \
    --platform "managed" \
    --region "us-central1" \
    --project "${PROJECT_ID}" \
    --concurrency 1 \
    --memory 1G \
    --allow-unauthenticated
done

echo "deploying cloud function for object notification..."
gcloud functions deploy handle_new_entity_data --runtime python37 --trigger-resource gs://wiki-staging --trigger-event google.storage.object.finalize
